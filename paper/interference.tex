\documentclass[12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage{xcolor}
\usepackage[plainruled,noline]{algorithm2e}

\input{macros.tex}

\begin{document}

\section{Register Allocation}

How to compute the \AMi-induced edges of the interference graph.

% A secret-dependent region:
%     - A tuple of (set(basic block), set(dir-edge), entry, exit)
%     - Fully connected
%     - exit block postdominates all blocks
%     - terminator of entry is secret dependent

% - Index(i), Index(bb)
%      defines a total order between instructions and between basic blocks
%         according to some linearization function
%                   (LLVM linearization, *not* AMi linearization)
%
%      the indexes are assigned such that 
%              for all instructions i:
%                 basic-block(i) < i
%
% - Defs(bb)
%       returns all defs within basic block bb 
% - Uses(bb)
%       returns all uses within basic block bb 
% - Uses(def)
%       returns all uses of def
% - Users(R, i)
%       returns all uses of instruction i within region R
% - Instructions(R)
%       returns the instructions of the region R
% - PersistentInstructions(R):
%       returns the persistent instructions of the region R
% - BasicBlock(i)
%       returns the basic block of the instruction i
% - Connected(bb1, bb2)
%        true if path from bb1 to bb2 or if path from bb2 to bb1
%              (bb2 is reachable from bb1 or bb1 is reachable from bb2)
% - Edge(u, v)
%        represents a directed edge from source u to target v

\begin{algorithm}
\Fn{\FComputeAMiInterferenceEdges{$R$}}{
  \DontPrintSemicolon
  %\SetCommentSty{\textcolor{blue}}
  \KwData{Secret-dependent region $R$}
  \KwResult{Set of \AMi-induced edges $E$}
  $E \gets \emptyset$\;
  \For{$p \in \FPersistentInstructions{R}$}{
    \For{$bb \in \FBasicBlocks{R} \mid \neg \FConnected(\FBasicBlock(p), bb)$}{

      \Comment{Case 1}
      \If{$\FIndex(bb) > \FIndex(\FBasicBlock(p))$}{

        \Comment{Case 1.1}
        \For{$user \in \FUsers(R, p)$}{
          \Assert{$\FIndex(user) < \FIndex(bb)$}\;
          \Comment{Else bug in \AMi{} tranformation?}
        }

        \Comment{Case 1.2}
        \For{$use \in \FUses(bb) \mid \FIndex(use) < \FIndex(p)$}{
          % TODO: Unless u already contains that slot index
          $E \gets E \cup \{\FEdge(p,use)\}$\;
          \Comment{LLVM: Add Segment(p) to LIS(use)}
        }
      }

      \Comment{Case 2}
      \If{$\FIndex(bb) < \FIndex(\FBasicBlock(p))$}{

        \Comment{Case 2.1}
        \For{$def \in \FDefs(bb)$} {
          \For{$use \in \FUses(def) \mid \FIndex(use) > \FIndex(p)$}{
            % TODO: Unless u already contains that slot index
            $E \gets E \cup \{\FEdge(def,p)\}$\;
            \Comment{LLVM: Add Segment(def) to LIS(p)}
          }
        }

        \Comment{Case 2.2}
      }
    }
  }
  \Return{$E$}
}
\end{algorithm}

\todo{What about spilling and splitting?}

\end{document}
