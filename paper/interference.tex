\documentclass[12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage{xcolor}
\usepackage[plainruled,noline]{algorithm2e}

\input{macros.tex}

\begin{document}

\section{Register Allocation}

How to compute the \AMi-induced edges of the interference graph.

% Assume more-or-less SSA (i.e., after phi-elimination)

% In a control-flow graph, a join point is a location where multiple control paths in the program converge.

% A secret-dependent region: (see also Libra paper for definition)
%     - A tuple of (set(basic block), set(dir-edge), entry, exit)
%     - Fully connected
%     - exit block postdominates all blocks
%     - terminator of entry is secret dependent

% - A linearization function defines a total order between instructions and
%    between basic blocks.
%    (LLVM linearization, *not* AMi linearization)
% => Index(i), Index(bb) are functions to retrieve the index of an instruction
%     and a basic block respectively within that order
%   Note that index(i) can be compared with Index(bb) (Abuse of notation?)
%
% - Users(R, i)
%       returns all users (instructions) of the register defined by
%         instruction i within region R
%
% - Operands(i)
%       returns all operands of the instruction
% - Operands(bb)
%       returns all operands of the instructions in a basic block

% - IsUse(op)
%       returns if the operand is a use
%
% - Def(op)
%       returns the defining instruction of the given operand
%          in SSA form this is a single instruction, in non-SSA form
%          this can be multiple instructions
%
% - Uses(bb)
%       returns all uses (instructions) within basic block bb 
%
% - Defs(bb)
%       returns all defs (instructions) within basic block bb 
% - Uses(def)
%       returns all uses (instrucions) of def

% - Instructions(R)
%       returns the instructions of the region R
% - Instructions(bb)
%       returns the instructions of the basic block bb
% - PersistentInstructions(R):
%       returns the persistent instructions of the region R
% - BasicBlock(i)
%       returns the basic block of the instruction i
% - Connected(bb1, bb2)
%        true if path from bb1 to bb2 or if path from bb2 to bb1
%              (bb2 is reachable from bb1 or bb1 is reachable from bb2)
% - Edge(u, v)
%        represents a directed edge from source u to target v

\begin{algorithm}
\Fn{\FComputeAMiInterferences{$R$}}{
  \DontPrintSemicolon
  %\SetCommentSty{\textcolor{blue}}
  \KwData{Secret-dependent region $R$}
  \KwResult{Set of \AMi-induced interference edges $E$}
  $E \gets \emptyset$\;
  \For{$p \in \FPersistentInstructions{R}$}{
    \For{$bb \in \FBasicBlocks{R} \mid \neg \FConnected(\FBasicBlock(p), bb)$}{

      \Comment{Case 1}
      \If{$\FIndex(bb) > \FIndex(\FBasicBlock(p))$}{

        \Comment{Case 1.1}
        \For{$user \in \FUsers(R, p)$}{
          \Assert{$\FIndex(user) < \FIndex(bb)$}\;
          \Comment{Else bug in \AMi{} tranformation?}
        }

        \Comment{Case 1.2}
        \For{$op \in \FOperands(bb) \mid \FIsUse(op)$}{
          \If{$\FIndex(\FDef(op)) < \FIndex(p)$}{
            $E \gets E \cup \{\FEdge(p,\FDef(op))\}$\;
            \Comment{LLVM: Add Segment(p) to LIS(use)}
            % TODO: Unless u already contains that slot index
          } 
        }
      }

      \Comment{Case 2}
      \If{$\FIndex(bb) < \FIndex(\FBasicBlock(p))$}{

        \Comment{Case 2.1}
        \For{$def \in \FDefs(bb)$} {
          \For{$use \in \FUses(def) \mid \FIndex(use) > \FIndex(p)$}{
            $E \gets E \cup \{\FEdge(def,p)\}$\;
            \Comment{LLVM: Add Segment(def) to LIS(p)}
            % TODO: Unless u already contains that slot index
          }
        }

        \Comment{Case 2.2}
        \For{$op \in \FOperands(p) \mid \FIsUse(op)$}{
          \If{$\FIndex(\FDef(op)) < \FIndex(bb)$} {
            \For{$i \in \FInstructions{bb}$} {
              $E \gets E \cup \{\FEdge(\FDef{op},i)\}$\;
              \Comment{LLVM: }
              % TODO: Unless u already contains that slot index
            }
          }
        }
      }
    }
  }
  \Return{$E$}
}
\end{algorithm}

\todo{What about spilling and splitting?}

\end{document}
